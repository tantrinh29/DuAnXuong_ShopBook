<%- include('layout/header.ejs') %>
  <%- include('layout/navbar.ejs', {categories: categories}) %>
  <% function formatNumber(num) {
    if (num == null) {
      return "0"; 
     } 
     return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,"); } 
     %>
     <style>
      /* Thêm CSS cho modal */
      .modal-content {
        color: #000; /* Màu chữ cho modal */
      }
    
      .modal-body {
        font-size: 16px; /* Kích thước chữ cho nội dung trong modal */
      }
    
      #addressList li {
        cursor: pointer;
        padding: 8px;
        border-bottom: 1px solid #ddd; /* Đường kẻ chia giữa các địa chỉ */
      }
    
      #addressList li:hover {
        background-color: #f0f0f0; /* Màu nền khi di chuột qua địa chỉ */
      }
    </style>
    
      <section class="breadcrumb-section">
        <h2 class="sr-only">Site Breadcrumb</h2>
        <div class="container">
          <div class="breadcrumb-contents">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active">Checkout</li>
              </ol>
            </nav>
          </div>
        </div>
      </section>
      <main id="content" class="page-section inner-page-sec-padding-bottom space-db--20">
        <div class="container">
          <div class="row">
            <div class="col-12">
              <!-- Checkout Form s-->
              <div class="checkout-form">
                <div class="row row-40">
                  
                  <div class="col-lg-7 mb--20">
                    <!-- Billing Address -->
                    <div id="billing-form" class="mb-40">
                      <h4 class="checkout-title">Địa chỉ thanh toán</h4>
                      <div class="row">
                        <div class="col-md-6 col-12 mb--20">
                          <label>Họ và tên *</label>
                          <input type="text" id="fullname" value="<%= userOrder.fullname %>" placeholder="Full Name" />
                        </div>

                        <div class="col-md-6 col-12 mb--20">
                          <label>Địa chỉ Email *</label>
                          <input type="email" id="email" value="<%= locals.email %>" placeholder="Email Address" />
                        </div>
                        <div class="col-md-6 col-12 mb--20">
                          <label>Số điện thoại *</label>
                          <input type="text" id="phone" placeholder="Số điện thoại" />
                        </div>
                        <div class="col-md-6 col-12 mb--20">
                          <label>Địa chỉ *</label>
                          <div class="input-group">
                            <input type="text" id="address" placeholder="Địa chỉ" disabled />
                            <div class="input-group-append">
                              <button class="btn btn-outline-secondary" type="button" onclick="openAddressModal()">Chọn Địa Chỉ</button>
                            </div>
                          </div>
                        </div>
                        <!-- Modal -->
                        <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Danh sách địa chỉ</h5>
       
                              </div>
                              <div class="modal-body">
                                <ul id="addressList"></ul>
                              </div>
      
                                <button class="btn btn-outline" type="button" onclick="addAddress()"><a href="/addresses">Thêm Địa Chỉ Mới</a></button>
      
                            </div>
                          </div>
                        </div>


                      </div>
                    </div>

                    <div class="order-note-block mt--5">
                      <label for="order-note">Ghi chú</label>
                      <textarea id="comment" cols="30" rows="10" class="order-note"
                        placeholder="Nhập Vấn Đề"></textarea>
                    </div>
                  </div>
                  <div class="col-lg-5">
                    <div class="row">
                      <!-- Cart Total -->
                      <div class="col-12">
                        <div class="checkout-cart-total">
                          <h2 class="checkout-title">Đơn hàng của bạn</h2>
                          <h4>Sản phẩm <span>Tổng</span></h4>
                          <ul>
                            <% if(products.length===0) { %>
                              <p class="text-center text-danger font-weight-bold">Your cart is empty.</p>
                              <% } else { %>
                                <% products.forEach(function(product) { %>
                                  <li>
                                    <span class="left">
                                      <%= product.item.title %> X <%= product.quantity %>
                                    </span>
                                    <span class="right">
                                      <%= formatNumber(product.item.price * product.quantity) %>
                                    </span>
                                  </li>
                                  <% }) %>
                                    <% } %>
                          </ul>
                          <p>Tổng đơn hàng <span>
                              <%= products.length !==0 ? formatNumber(totalPrice) : 0 %> VNĐ
                            </span></p>
                          <input type="hidden" name="totalPrice" id="totalPrice" value="<%= totalPrice %>" />
                          <p>Phí vận chuyển<span>0 VNĐ</span></p>

                          <br>
                          <div>
                            <input type="radio" style="height: 15px; width: 30px;padding-right: 20px;" id="vnpay"
                              name="paymentMethod" value="vnpay" />

                            <label htmlFor="vnpay" className="text-[17px] text-normal text-black">
                              Thanh Toán VnPay
                            </label>
                          </div>

                          



                          <input type="radio" style="height: 15px; width: 30px;" id="delivery" name="paymentMethod"
                            value="delivery" />
                          <label htmlFor="delivery" className="text-[17px] text-normal text-black">
                            Thanh Toán Khi Giao Hàng
                          </label>

                        </div>
                        <div class="term-block">
                          <button id="addOrderCart" class="place-order w-100">Đặt hàng</button>


                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      <script>
        // Gửi Data
        $("#addOrderCart").on("click", function () {
          $.ajax({
            type: "POST",
            dataType: "JSON",
            url: `/orderPayment/${$("input[name='paymentMethod']:checked").val()}`,
            data: {
              type: 'orderCart',
              fullname: $("#fullname").val(),
              email: $("#email").val(),
              phone: $("#phone").val(),
              address: $("#address").val(),
              comment: $("#comment").val(),
              totalPrice: $("#totalPrice").val(),
              paymentMethod: $("input[name='paymentMethod']:checked").val(),
            },
            success: function (res) {
              window.location.href = res.vnpUrl;
            },
            error: function (xhr, status, error) {
              console.error(error);
            },
          });
        });

      </script>
      <script>
        async function openAddressModal() {
    try {
      // Gọi API để lấy danh sách địa chỉ
      const response = await fetch('/api/user-addresses');
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const addresses = await response.json();

      // Cập nhật modal với danh sách địa chỉ
      updateAddressModal(addresses);

      // Hiển thị modal
      $('#addressModal').modal('show');
    } catch (error) {
      console.error('Error fetching user addresses:', error);
    }
  }

      
        function updateAddressModal(addresses) {
          const addressList = document.getElementById('addressList');
          addressList.innerHTML = '';
      
          addresses.forEach(address => {
            const li = document.createElement('li');
            li.textContent = `${address.street}, ${address.city}, ${address.country}`;
            li.onclick = function() {
              selectAddress(address);
              $('#addressModal').modal('hide');
            };
            addressList.appendChild(li);
          });
        }
      
        function selectAddress(address) {
          document.getElementById('address').value = `${address.street}, ${address.city}, ${address.country}`;
        }
      </script>
      
      <%- include('layout/footer.ejs') %>